<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>Hurricane Simulation</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='js/mapbox-gl.js'></script>
    <link href='js/mapbox-gl.css' rel='stylesheet' />
    <script src='js/mapbox-gl-draw.js'></script>
    <link href="js/mapbox-gl-draw.css" rel="stylesheet" />   
    <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>

    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
        #bufferbutton{
        min-height: 20px;
        background-color: #3887be;
        color: #fff;
        font-family: 'Open Sans';
        border-radius: 5px;
        padding: 10px;
        cursor: pointer;
        margin: 10px 0;
        height: 140px;
        width: 150px;
        position: absolute;
        top: 210px;
        left: 10px;
        background-color: rgba(255, 255, 255, .9);
        padding: 15px;
        text-align: center;
        }

    </style>
</head>
<body>

<div id='map'></div>
<div id='bufferbutton' class='button'>bufferstorm</div>

<script>
//@START
//Tyler's code
        var mortality = {1:0.000006133333,
                        2:0.0007031099,
                        3:0.0050465876,
                        4:0.0342701136,
                        5:0.0251089529
        };

        //Returns the body counts from a list of populations, given the category of hurricane on top of them.
        function deathsLists(populations,cat) {
            var total = 0;
            for(var i=0;i<populations.length;i++) {
                total+=deaths(populations[i],cat);
            }
            return total;
        }

        //Returns the body count from a population, given the category of hurricane on top of it.
        function deaths(population, cat) {
            return population*mortality[cat];
        }

        //Returns the total body count
        function bodyCount(counties,hurricane,category) {
            var totalPop = 0;
            for(var i=0;i<counties.length;i++) {
                if(counties[i].properties.B01003001) {
					try{
						if(turf.intersect(counties[i], hurricane.features[0])!=null)
							totalPop+=counties[i].properties.B01003001;
					} catch(e){}                    
                }
            }
            return deaths(totalPop, category);
        }


        //Static test stuff
        for(var num =1;num<6;num++) {
            console.log(deaths(1000,num));
        }

//@END




    mapboxgl.accessToken = 'pk.eyJ1IjoiemhpayIsImEiOiJjaW1pbGFpdHQwMGNidnBrZzU5MjF5MTJiIn0.N-EURex2qvfEiBsm-W9j7w';

    let map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v9',
    center: [-73.9712,40.7831],
    minZoom: 4,
    zoom: 5
    });


map.on('style.load', function() {
    map.addSource('counties', {
        "type": "vector",
        "url": "mapbox://zhik.0dg3a5tc"
    });

    map.addSource('water', {
        "type": "vector",
        "url": "mapbox://zhik.81hc6tfw"
    });


    map.addLayer({
        "id": "counties1",
        "type": "fill",
        "source": "counties",
        "source-layer": "acs2014_5yr_B01003_05000US560-3isjt9",
        "paint": {
            "fill-outline-color": "rgba(0,0,0,0.1)",
            "fill-color": "rgba(0,0,0,0.1)"
        }
    }, 'place-city-sm');

    map.addLayer({
        "id": "water1",
        "type": "fill",
        "source": "water",
        "source-layer": "simplified-water-polygons-com-2kj5lv",
        "paint": {
            "fill-color": "rgba(55,107,158, 0.8)"
        }
    }, 'counties1');
        
    /*map.addLayer({
        "id": "counties-highlighted",
        "type": "fill",
        "source": "counties",
        "source-layer": "acs2014_5yr_B01003_05000US560-3isjt9",
        "paint": {
            "fill-outline-color": "#484896",
            "fill-color": "#6e599f",
            "fill-opacity": 0.75
        },
        "filter": ["in", "FIPS", ""]
    }); */

    //make draw controls
    let Draw = mapboxgl.Draw({
      displayControlsDefault: false,
      controls: {
        'line_string': true
      }
    });
    map.addControl(Draw);

    //get all draw layers and make the buffers
    const bufferbutton = document.getElementById('bufferbutton');
    bufferbutton.onclick = function() {
        const storm = Draw.getAll();
        //add if statement for if storm is empty
        const bufferstorm = turf.buffer(storm, 1, 'miles');
        Draw.deleteAll() 
        Draw.add(bufferstorm); // add to it's own layer , not the draw layer
        
		console.log(getCountyBodyCount(bufferstorm, '5'));
		console.log(onOcean(bufferstorm));
	};
	

    function onOcean(bufferstorm) {
		const features = map.queryRenderedFeatures({ 
			layers: ['water1']
		});
        let ocean = false;
        for(var i=0;i<features.length;i++) {
            try{
                if(turf.union(features[i], bufferstorm.features[0])!=null){      
                    ocean = true         
                }
            } catch(e){}      
        }
	    return ocean;
	}

	function getCountyBodyCount(bufferstorm, cat) {
		const features = map.queryRenderedFeatures(bufferstorm, { 
			layers: ['counties1'], 
			filter: ['has','feature.properties.B01003001']
		});
		return bodyCount(features, bufferstorm, cat);
	}
	
	
});

</script>
</body>
</html>